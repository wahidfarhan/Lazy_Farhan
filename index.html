<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Practice C - Run Your Code</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github-dark.min.css" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/wcoder/highlightjs-line-numbers.js@2.8.0/dist/highlightjs-line-numbers.min.css" />
  <style>
    /* CSS remains the same as previously provided */
  </style>
</head>
<body>
  <div id="container">
    <div id="sidebar">
      <h2>My Practice C</h2>
      <ul id="fileList"><li>Loading files...</li></ul>
    </div>
    <div id="main">
      <div id="codeSection">
        <div id="codeContainer">
          <pre><code id="codeBlock" class="c hljs"></code></pre>
        </div>
        <div id="ioSide">
          <div class="io-box">
            <label for="input">üì• Input</label>
            <textarea id="input" placeholder="Input will be loaded here or you can type"></textarea>
          </div>
          <div class="io-box">
            <label for="output">üì§ Output</label>
            <textarea id="output" readonly placeholder="Program output will appear here"></textarea>
          </div>
          <div class="io-box">
            <label>‚úÖ Expected Output</label>
            <div id="expectedOutput" class="readonly-box">Not loaded</div>
          </div>
          <div class="io-box">
            <label>üìù Description <span id="fileNameLabel"></span></label>
            <div id="descriptionBox" class="readonly-box">No description available.</div>
          </div>
        </div>
      </div>
      <button id="runBtn">Run Code</button>
      <div id="statusMsg"></div>
      <div id="uploadedDate"></div>
    </div>
  </div>
  <div id="typingContainer"><div id="typingText"></div></div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/languages/c.min.js"></script>
  <script src="https://cdn.jsdelivr.net/gh/wcoder/highlightjs-line-numbers.js@2.8.0/dist/highlightjs-line-numbers.min.js"></script>
  <script>
    const repoOwner = "wahidfarhan";
    const repoName = "Lazy_Farhan";
    const folderPath = "codes";
    const rapidApiHost = "judge0-ce.p.rapidapi.com";
    const rapidApiKey = "2ffb7c9968msh2aaee0147c376edp10350djsne858c3d03a02";

    const fileListEl = document.getElementById("fileList");
    const codeBlockEl = document.getElementById("codeBlock");
    const inputEl = document.getElementById("input");
    const outputEl = document.getElementById("output");
    const runBtn = document.getElementById("runBtn");
    const statusMsg = document.getElementById("statusMsg");
    const descriptionEl = document.getElementById("descriptionBox");
    const expectedOutputEl = document.getElementById("expectedOutput");
    const fileNameLabel = document.getElementById("fileNameLabel");
    const uploadedDateEl = document.getElementById("uploadedDate");

    let currentCode = "";
    let pathStack = [];

    async function fetchFileList(folder = folderPath) {
      try {
        const apiUrl = `https://api.github.com/repos/${repoOwner}/${repoName}/contents/${folder}`;
        const res = await fetch(apiUrl);
        if (!res.ok) throw new Error("Failed to fetch file list");
        const data = await res.json();

        fileListEl.innerHTML = "";

        if (folder !== folderPath) {
          const backBtn = document.createElement("li");
          backBtn.textContent = "‚¨ÖÔ∏è Back";
          backBtn.style.fontWeight = "bold";
          backBtn.addEventListener("click", () => {
            const prev = pathStack.pop();
            fetchFileList(prev || folderPath);
          });
          fileListEl.appendChild(backBtn);
        }

        data.filter(i => i.type === "dir").forEach(dir => {
          const li = document.createElement("li");
          li.textContent = `üìÅ ${dir.name}`;
          li.addEventListener("click", () => {
            pathStack.push(folder);
            fetchFileList(`${folder}/${dir.name}`);
          });
          fileListEl.appendChild(li);
        });

        data.filter(i => i.type === "file" && i.name.endsWith(".c")).forEach(file => {
          const li = document.createElement("li");
          li.textContent = file.name;
          li.addEventListener("click", () => selectFile(file, li));
          fileListEl.appendChild(li);
        });
      } catch (err) {
        fileListEl.innerHTML = `<li style="color:red;">Error loading files</li>`;
        console.error(err);
      }
    }

    function parseInputFile(text) {
      const lines = text.split(/\r?\n/);
      let inputLines = [], descriptionLines = [], outputLines = [];
      let section = "input";

      for (let line of lines) {
        const lower = line.trim().toLowerCase();
        if (lower === "description") section = "description";
        else if (lower === "output") section = "output";
        else {
          if (section === "input") inputLines.push(line);
          else if (section === "description") descriptionLines.push(line);
          else if (section === "output") outputLines.push(line);
        }
      }

      return {
        input: inputLines.join("\n").trim(),
        description: descriptionLines.join("\n").trim(),
        output: outputLines.join("\n").trim()
      };
    }

    async function getFileLastCommitDate(filePath) {
      try {
        const commitsApiUrl = `https://api.github.com/repos/${repoOwner}/${repoName}/commits?path=${filePath}&page=1&per_page=1`;
        const res = await fetch(commitsApiUrl);
        if (!res.ok) throw new Error("Failed to fetch commits");
        const commits = await res.json();
        if (commits.length && commits[0].commit && commits[0].commit.author) {
          return commits[0].commit.author.date;
        }
        return null;
      } catch {
        return null;
      }
    }

    async function selectFile(file, li) {
      [...fileListEl.children].forEach(el => el.classList.remove("active"));
      li.classList.add("active");

      try {
        const res = await fetch(file.download_url);
        if (!res.ok) throw new Error("Failed to fetch code");
        const codeText = await res.text();

        currentCode = codeText;
        codeBlockEl.textContent = currentCode;
        hljs.highlightElement(codeBlockEl);
        hljs.lineNumbersBlock(codeBlockEl);
      } catch (err) {
        statusMsg.textContent = "Error loading code file.";
        console.error(err);
        return;
      }

      fileNameLabel.textContent = `(${file.name})`;

      const commitDate = await getFileLastCommitDate(`${file.path}`);
      if (commitDate) {
        const d = new Date(commitDate);
        uploadedDateEl.textContent = `uploaded in ${d.getFullYear()}-${(d.getMonth() + 1).toString().padStart(2, '0')}-${d.getDate().toString().padStart(2, '0')} ${d.getHours().toString().padStart(2, '0')}:${d.getMinutes().toString().padStart(2, '0')}`;
      } else uploadedDateEl.textContent = "";

      const baseName = file.name.replace(/\.c$/, "");
      const inputUrl = file.download_url.replace(/\/[^\/]+$/, `/${baseName}.in`);

      try {
        const inputRes = await fetch(inputUrl);
        if (inputRes.ok) {
          const inputText = await inputRes.text();
          const parsed = parseInputFile(inputText);
          inputEl.value = parsed.input || "";
          descriptionEl.textContent = parsed.description || "No description.";
          expectedOutputEl.textContent = parsed.output || "Not available.";
        } else {
          inputEl.value = "";
          descriptionEl.textContent = "No input or description found.";
          expectedOutputEl.textContent = "Not available.";
        }
      } catch {
        inputEl.value = "";
        descriptionEl.textContent = "No input or description found.";
        expectedOutputEl.textContent = "Not available.";
      }

      outputEl.value = "";
      statusMsg.textContent = "";
    }

    async function runCode() {
      if (!currentCode) return alert("Please select a C file first.");
      runBtn.disabled = true;
      statusMsg.textContent = "Running...";
      outputEl.value = "";

      try {
        const res = await fetch(`https://${rapidApiHost}/submissions?base64_encoded=false&wait=true`, {
          method: "POST",
          headers: {
            "content-type": "application/json",
            "X-RapidAPI-Host": rapidApiHost,
            "X-RapidAPI-Key": rapidApiKey
          },
          body: JSON.stringify({ source_code: currentCode, language_id: 50, stdin: inputEl.value })
        });

        const result = await res.json();
        if (result.compile_output) outputEl.value = `Compile Error:\n${result.compile_output}`;
        else if (result.stderr) outputEl.value = `Runtime Error:\n${result.stderr}`;
        else if (result.stdout) outputEl.value = result.stdout;
        else outputEl.value = "No output.";
      } catch (error) {
        outputEl.value = "Error running code: " + error.message;
      } finally {
        statusMsg.textContent = "";
        runBtn.disabled = false;
      }
    }

    runBtn.addEventListener("click", runCode);
    fetchFileList();

    const typingTextEl = document.getElementById("typingText");
    const textToType = "lazy_farhan";
    let charIndex = 0, isDeleting = false;

    function type() {
      typingTextEl.textContent = textToType.substring(0, charIndex);
      if (!isDeleting) {
        charIndex++;
        if (charIndex <= textToType.length) setTimeout(type, 150);
        else setTimeout(() => { isDeleting = true; type(); }, 1200);
      } else {
        charIndex--;
        if (charIndex >= 0) setTimeout(type, 80);
        else { isDeleting = false; setTimeout(type, 150); }
      }
    }

    type();
  </script>
</body>
</html>
